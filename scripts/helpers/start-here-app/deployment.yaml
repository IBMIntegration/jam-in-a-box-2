---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{APP}}-nginx-config
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      
      # Basic auth file
      auth_basic_user_file /etc/nginx/.htpasswd;
      
      server {
        listen {{PORT}};
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;
        
        # Enable Server Side Includes for HTML files
        ssi on;
        ssi_silent_errors off;
        ssi_types text/shtml;
        
        # Handle HTML files with SSI enabled
        location ~ \.html$ {
          ssi on;
          auth_basic "Restricted Area";
        }
        
        # Disable script execution
        location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
          return 403;
        }
        
        # Public access for public directory
        location /public/ {
          # No auth required
        }
        location /js/ {
          # No auth required
        }
        
        # Proxy requests to rest-proxy container (requires auth)
        location /proxy/ {
          auth_basic "Restricted Area";
          proxy_pass http://localhost:3000/proxy/;
          proxy_set_header Host \$host;
          proxy_set_header X-Real-IP \$remote_addr;
          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto \$scheme;
        }
        
        # Everything else requires auth (including index.html)
        location / {
          auth_basic "Restricted Area";
          try_files $uri $uri/ /404.html;

          location /tracks {
            proxy_pass http://{{NAME}}-md-handler.{{NAMESPACE}}.svc.cluster.local:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
          }

          # Only serve index.html for root path
          location = / {
            try_files /index.html /404.html;
          }
        }
        
        # Custom 404 error page
        error_page 404 /404.html;
        location = /404.html {
          auth_basic "Restricted Area";
          internal;
        }
      }
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: {{NAME}}-app-credentials
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
type: Opaque
data:
  username: {{USERNAME_BASE64}}
  password: {{PASSWORD_BASE64}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{NAME}}-md-handler-config
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
data:
  config.json: |
    {
      "_comment": "Main MD Handler Server Configuration",
      "port": 8081,
      "basePath": "/materials",
      "host": "0.0.0.0",
      "admin-port": 8082,
      "admin-host": "0.0.0.0"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jb-start-here
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{LABEL_APP}}
  template:
    metadata:
      labels:
        app: {{LABEL_APP}}
    spec:
      initContainers:
      - name: setup
        image: registry.redhat.io/ubi8/nodejs-20:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Copying entrypoint scripts..."
          cp /scripts-src/* /scripts-dest/
          chmod +x /scripts-dest/*
          echo "Scripts copied and made executable:"
          ls -la /scripts-dest/
          echo "Running config generator script..."
          node /scripts-init/config-generator.js
        volumeMounts:
        - name: scripts-source
          mountPath: /scripts-src
        - name: entrypoint-scripts
          mountPath: /scripts-dest
        - name: setup-config
          mountPath: /scripts-init
        - name: setup-output-config
          mountPath: /config/setup.json
          subPath: setup.json
        - name: setup-secrets
          mountPath: /config/secret.json
          subPath: secret.json
        - name: generated-configs
          mountPath: /config/generated
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: {{PORT}}
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: htpasswd
          mountPath: /etc/nginx/.htpasswd
          subPath: .htpasswd
        - name: entrypoint-scripts
          mountPath: /docker-entrypoint.d
        - name: htdocs-archive
          mountPath: /archive
        - name: html-content
          mountPath: /usr/share/nginx/html
        - name: generated-configs
          mountPath: /usr/share/nginx/html/config
        - name: nginx-cache
          mountPath: /var/cache/nginx
        - name: runtime-data
          mountPath: /var/run
      - name: rest-proxy
        image: registry.redhat.io/ubi8/nodejs-20:latest
        ports:
        - containerPort: 3000
        command: ["node", "/app/rest-proxy.js"]
        volumeMounts:
        - name: rest-proxy-script
          mountPath: /app
      volumes:
      - name: nginx-config
        configMap:
          name: {{NAME}}-nginx-config
      - name: htpasswd
        secret:
          secretName: {{NAME}}-nginx-auth
      - name: scripts-source
        configMap:
          name: {{NAME}}-scripts
      - name: entrypoint-scripts
        emptyDir: {}
      - name: generated-configs
        emptyDir: {}
      - name: htdocs-archive
        configMap:
          name: {{NAME}}-htdocs
      - name: html-content
        emptyDir: {}
      - name: setup-config
        configMap:
          name: {{NAME}}-scripts-init
      - name: setup-output-config
        configMap:
          name: jb-setup-output
      - name: setup-secrets
        secret:
          secretName: jb-setup-secrets
      - name: nginx-cache
        emptyDir: {}
      - name: runtime-data
        emptyDir: {}
      - name: rest-proxy-script
        configMap:
          name: {{NAME}}-rest-proxy
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{NAME}}-md-handler
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
  annotations:
    # Enable automatic updates when ImageStream changes
    image.openshift.io/triggers: |
      [{"from":{"kind":"ImageStreamTag","name":"md-handler:latest"},"fieldPath":"spec.template.spec.containers[0].image"}]
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{LABEL_APP}}
      component: md-handler
  template:
    metadata:
      labels:
        app: {{LABEL_APP}}
        component: md-handler
    spec:
      initContainers:
      - name: fetch-materials
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Installing required tools..."
          apk add --no-cache curl tar
          echo "Downloading materials archive from git repository..."
          ARCHIVE_URL="https://raw.githubusercontent.com/capnajax/integration-jam-in-a-box/{{GIT_BRANCH}}/archives/materials.tar.gz"
          echo "Fetching archive from: ${ARCHIVE_URL}"
          if wget -O /tmp/materials.tar.gz "${ARCHIVE_URL}"; then
                  echo "Archive downloaded successfully"
            echo "Extracting materials to shared volume..."
            cd /shared-materials
            tar -xzf /tmp/materials.tar.gz --strip-components=1
            echo "Materials extracted successfully"
            ls -la /shared-materials/
          else
            echo "Failed to download materials archive"
            echo "Falling back to downloading individual files..."
            mkdir -p /shared-materials/tracks
            # Create a basic index if archive is not available
            echo "# Materials" > /shared-materials/tracks/index.md
            echo "Materials archive not available for branch {{GIT_BRANCH}}" >> /shared-materials/tracks/index.md
          fi
          echo "Init container completed"
        volumeMounts:
        - name: materials-volume
          mountPath: /shared-materials
      containers:
      - name: md-handler
        image: md-handler:latest
        ports:
        - containerPort: 8081
          name: http
        - containerPort: 8082
          name: admin
        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "8081"
        - name: BASE_PATH
          value: "/materials"
        - name: HOST
          value: "0.0.0.0"
        - name: ADMIN_PORT
          value: "8082"
        - name: ADMIN_HOST
          value: "0.0.0.0"
        volumeMounts:
        - name: materials-volume
          mountPath: /materials
        - name: md-handler-config
          mountPath: /opt/app-root/src/config
        livenessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        workingDir: /opt/app-root/src
      volumes:
      - name: materials-volume
        emptyDir: {}
      - name: md-handler-config
        configMap:
          name: {{NAME}}-md-handler-config
---
apiVersion: v1
kind: Service
metadata:
  name: {{NAME}}
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
spec:
  type: ClusterIP
  ports:
  - port: {{PORT}}
    targetPort: {{PORT}}
    protocol: TCP
    name: nginx
  selector:
    app: {{LABEL_APP}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{NAME}}-md-handler
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
spec:
  type: ClusterIP
  ports:
  - port: 8081
    targetPort: 8081
    protocol: TCP
    name: md-handler
  selector:
    app: {{LABEL_APP}}
    component: md-handler
---
apiVersion: v1
kind: Service
metadata:
  name: {{NAME}}-md-handler-admin
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
    service-type: admin
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - port: 8082
    targetPort: 8082
    protocol: TCP
    name: admin
  selector:
    app: {{LABEL_APP}}
    component: md-handler
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: {{ROUTE_BASENAME}}
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
spec:
  to:
    kind: Service
    name: {{NAME}}
  port:
    targetPort: {{PORT}}
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: {{NAME}}-md-handler
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
spec:
  to:
    kind: Service
    name: {{NAME}}-md-handler
  port:
    targetPort: 8081
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
