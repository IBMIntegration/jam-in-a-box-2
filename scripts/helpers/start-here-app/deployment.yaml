---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{APP}}-nginx-config
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      
      # Basic auth file
      auth_basic_user_file /etc/nginx/.htpasswd;
      
      server {
        listen {{PORT}};
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;
        
        # Enable Server Side Includes for HTML files
        ssi on;
        ssi_silent_errors off;
        ssi_types text/shtml;
        
        # Disable script execution
        location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
          return 403;
        }
        
        # Public access for public directory
        location /public/ {
          # No auth required
        }
        location /js/ {
          # No auth required
        }
        
        # Proxy requests to rest-proxy container (requires auth)
        location /proxy/ {
          auth_basic "Restricted Area";
          proxy_pass http://localhost:3000/proxy/;
          proxy_set_header Host \$host;
          proxy_set_header X-Real-IP \$remote_addr;
          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto \$scheme;
        }
        
        # Proxy ALL /tracks requests to md-handler (higher priority than HTML regex)
        location /tracks {
          auth_basic "Restricted Area";
          proxy_pass http://localhost:8081;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Handle HTML files with SSI enabled (but exclude /tracks paths)
        location ~ ^(?!/tracks).*\.html$ {
          ssi on;
          auth_basic "Restricted Area";
        }
        
        # Everything else requires auth (including index.html)
        location / {
          auth_basic "Restricted Area";
          try_files $uri $uri/ /404.html;

          # Only serve index.html for root path
          location = / {
            try_files /index.html /404.html;
          }
        }
        
        # Custom 404 error page
        error_page 404 /404.html;
        location = /404.html {
          auth_basic "Restricted Area";
          internal;
        }
      }
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: {{NAME}}-app-credentials
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
type: Opaque
data:
  username: {{USERNAME_BASE64}}
  password: {{PASSWORD_BASE64}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{NAME}}-md-handler-config
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
data:
  config.json: |
    {
      "_comment": "Main MD Handler Server Configuration",
      "port": 8081,
      "basePath": "/materials",
      "host": "0.0.0.0",
      "admin-port": 8082,
      "admin-host": "0.0.0.0"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jam-in-a-box
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{LABEL_APP}}
  template:
    metadata:
      labels:
        app: {{LABEL_APP}}
    spec:
      initContainers:
      - name: htdocs-fetcher
        image: alpine:latest
        securityContext:
          runAsUser: 0
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "=== Htdocs Fetcher Init Container ==="
          echo "Installing required tools..."
          apk add --no-cache git
          echo "Cloning repository to get htdocs content..."
          git clone -b {{GIT_BRANCH}} --depth 1 {{REPO_GIT_URL}} /tmp/repo
          echo "Repository cloned successfully. Checking for htdocs..."
          echo "Repository structure:"
          ls -la /tmp/repo/
          echo "Start-here-app directory:"
          ls -la /tmp/repo/scripts/helpers/start-here-app/ || echo "start-here-app directory not found"
          
          if [ -d "/tmp/repo/scripts/helpers/start-here-app/htdocs" ]; then
            echo "Found htdocs directory, showing contents:"
            ls -la /tmp/repo/scripts/helpers/start-here-app/htdocs/
            echo "Copying content to shared volume..."
            
            # Ensure target directory exists
            mkdir -p /shared-htdocs
            
            # Copy all content
            if cp -r /tmp/repo/scripts/helpers/start-here-app/htdocs/* /shared-htdocs/ 2>/dev/null; then
              echo "Content copied successfully"
            else
              echo "Copy command failed or no files to copy"
            fi
            
            # Show what we have now
            echo "Final htdocs contents:"
            ls -la /shared-htdocs/ || echo "No files in shared htdocs"
            
          else
            echo "Htdocs directory not found at expected location"
            echo "Available directories in scripts/helpers/:"
            ls -la /tmp/repo/scripts/helpers/ || echo "helpers directory not found"
          fi
          
          # Always create a basic index if nothing exists
          if [ ! -f "/shared-htdocs/index.html" ]; then
            echo "Creating fallback index.html..."
            mkdir -p /shared-htdocs
            cat > /shared-htdocs/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Start Here App - Debug</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 50px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .warning { background: #fff3cd; padding: 15px; border-radius: 5px; }
                  .debug { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Start Here App - Debug Mode</h1>
                  <div class="warning">
                      <h3>⚠️ No Content Directory Found</h3>
                      <p>The htdocs directory was not found in the repository.</p>
                      <p>Expected location: <code>scripts/helpers/start-here-app/htdocs/</code></p>
                  </div>
                  <div class="debug">
                      <h3>Debug Information</h3>
                      <p>This page was generated because no htdocs directory was found.</p>
                      <p>Repository: {{REPO_GIT_URL}}</p>
                      <p>Branch: {{GIT_BRANCH}}</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
            echo "Created fallback index.html"
          fi
          echo "=== Htdocs fetcher completed ==="
        volumeMounts:
        - name: html-content
          mountPath: /shared-htdocs
      - name: setup
        image: registry.redhat.io/ubi8/nodejs-20:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Running config generator script..."
          node /scripts-init/config-generator.js
        volumeMounts:
        - name: setup-config
          mountPath: /scripts-init
        - name: setup-output-config
          mountPath: /config/setup.json
          subPath: setup.json
        - name: setup-secrets
          mountPath: /config/secret.json
          subPath: secret.json
        - name: generated-configs
          mountPath: /config/generated
      - name: fetch-materials
        image: alpine:latest
        securityContext:
          runAsUser: 0
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "=== Materials Fetcher Init Container ==="
          echo "Installing required tools..."
          apk add --no-cache curl tar wget git
          echo "Attempting to download materials archive..."
          ARCHIVE_URL="{{REPO_RAW_BASE_URL}}/{{GIT_BRANCH}}/archives/materials.tar.gz"
          echo "Fetching archive from: ${ARCHIVE_URL}"
          
          # Try wget first, then curl
          DOWNLOAD_SUCCESS=false
          if wget -O /tmp/materials.tar.gz "${ARCHIVE_URL}" 2>/dev/null; then
            echo "Archive downloaded successfully with wget"
            DOWNLOAD_SUCCESS=true
          elif curl -L -o /tmp/materials.tar.gz "${ARCHIVE_URL}" 2>/dev/null; then
            echo "Archive downloaded successfully with curl"
            DOWNLOAD_SUCCESS=true
          fi
          
          if [ "$DOWNLOAD_SUCCESS" = "true" ] && [ -f "/tmp/materials.tar.gz" ]; then
            echo "Extracting materials to shared volume..."
            cd /shared-materials
            if tar -xzf /tmp/materials.tar.gz --strip-components=1 2>/dev/null; then
              echo "Materials extracted successfully"
              ls -la /shared-materials/
            else
              echo "Failed to extract archive, trying without strip-components"
              tar -xzf /tmp/materials.tar.gz 2>/dev/null || echo "Extraction failed completely"
              ls -la /shared-materials/
            fi
          else
            echo "Failed to download materials archive, trying direct git clone..."
            git clone -b {{GIT_BRANCH}} --depth 1 {{REPO_GIT_URL}} /tmp/repo
            if [ -d "/tmp/repo/materials" ]; then
              echo "Found materials directory in repo, copying..."
              cp -r /tmp/repo/materials/* /shared-materials/ 2>/dev/null || echo "No materials to copy"
            else
              echo "No materials directory found, creating fallback..."
              mkdir -p /shared-materials/tracks
              echo "# Materials" > /shared-materials/tracks/index.md
              echo "Materials not available for branch {{GIT_BRANCH}}" >> /shared-materials/tracks/index.md
            fi
          fi
          echo "=== Materials fetcher completed ==="
        volumeMounts:
        - name: materials-volume
          mountPath: /shared-materials
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: {{PORT}}
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: htpasswd
          mountPath: /etc/nginx/.htpasswd
          subPath: .htpasswd
        - name: html-content
          mountPath: /usr/share/nginx/html
        - name: generated-configs
          mountPath: /usr/share/nginx/html/config
        - name: nginx-cache
          mountPath: /var/cache/nginx
        - name: runtime-data
          mountPath: /var/run
      - name: rest-proxy
        image: registry.redhat.io/ubi8/nodejs-20:latest
        ports:
        - containerPort: 3000
        command: ["node", "/app/rest-proxy.js"]
        volumeMounts:
        - name: rest-proxy-script
          mountPath: /app
      - name: md-handler
        image: image-registry.openshift-image-registry.svc:5000/jam-in-a-box/md-handler:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8081
          name: http
        - containerPort: 8082
          name: admin
        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "8081"
        - name: BASE_PATH
          value: "/materials"
        - name: HOST
          value: "0.0.0.0"
        - name: ADMIN_PORT
          value: "8082"
        - name: ADMIN_HOST
          value: "0.0.0.0"
        volumeMounts:
        - name: materials-volume
          mountPath: /materials
        - name: md-handler-config
          mountPath: /opt/app-root/src/config
        - name: html-content
          mountPath: /shared-includes
          readOnly: true
        livenessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        workingDir: /opt/app-root/src
      volumes:
      - name: nginx-config
        configMap:
          name: {{NAME}}-nginx-config
      - name: htpasswd
        secret:
          secretName: {{NAME}}-nginx-auth
      - name: generated-configs
        emptyDir: {}
      - name: html-content
        emptyDir: {}
      - name: setup-config
        configMap:
          name: {{NAME}}-scripts-init
      - name: setup-output-config
        configMap:
          name: jb-setup-output
      - name: setup-secrets
        secret:
          secretName: jb-setup-secrets
      - name: nginx-cache
        emptyDir: {}
      - name: runtime-data
        emptyDir: {}
      - name: rest-proxy-script
        configMap:
          name: {{NAME}}-rest-proxy
      - name: materials-volume
        emptyDir: {}
      - name: md-handler-config
        configMap:
          name: {{NAME}}-md-handler-config
---
apiVersion: v1
kind: Service
metadata:
  name: {{NAME}}
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
spec:
  type: ClusterIP
  ports:
  - port: {{PORT}}
    targetPort: {{PORT}}
    protocol: TCP
    name: nginx
  - port: 8081
    targetPort: 8081
    protocol: TCP
    name: md-handler
  selector:
    app: {{LABEL_APP}}
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: {{ROUTE_BASENAME}}
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
spec:
  to:
    kind: Service
    name: {{NAME}}
  port:
    targetPort: {{PORT}}
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: {{NAME}}-md-handler
  namespace: {{NAMESPACE}}
  labels:
    app: {{LABEL_APP}}
    component: md-handler
spec:
  to:
    kind: Service
    name: {{NAME}}
  port:
    targetPort: 8081
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
